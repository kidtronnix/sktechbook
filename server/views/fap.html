<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8"> 
        <title>Fapsearches.info</title>
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="http://getbootstrap.com/dist/css/bootstrap.css" rel="stylesheet">

        <!--[if lt IE 9]>
        <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->










        <!-- CSS code from Bootply.com editor -->
        
        <style type="text/css">
            /* move special fonts to HTML head for better performance */
@import url('http://fonts.googleapis.com/css?family=Open+Sans:200,300,400,600,700');


/* custom template */
html, body {
   height: 100%;
   font-family:'Open Sans',arial,sans-serif;
}

a {
  color:#222222;
}

.wrapper, .row {
   height: 100%;
   margin-left:0;
   margin-right:0;
}

.wrapper:before, .wrapper:after,
.column:before, .column:after {
    content: "";
    display: table;
}

.wrapper:after,
.column:after {
    clear: both;
}

.column {
    height: 100%;
    overflow: auto;
    *zoom:1;
}

.column .padding {
    padding: 20px;
}

.box {
  	bottom: 0; /* increase for footer use */
    left: 0;
    position: absolute;
    right: 0;
    top: 0;
    /*background-image:url('http://www.bootply.com/assets/example/bg_suburb.jpg');*/
    background-image:url('/images/abstract-bodies.jpg');
    background-size:cover;
    background-attachment:fixed;
    background-position: center;
}

.divider {
	margin-top:32px;
}

#main {
    background-color:#fefefe;
}
#main .img-circle {
  margin-top:18px;
  height:70px;
  width:70px;
}

#sidebar, #sidebar a {
    color:#ffffff;
    background-color:transparent;
	text-shadow:1px 0 1px #888888;
}
#sidebar a.logo {
  display:block;
  padding:3px;
  background-color:#fff;
  color:#777777;
  height:40px;
  width:40px;
  margin:15px;
  font-size:26px;
  font-weight:700;
  text-align:center;
  text-decoration:none;
  text-shadow:0 0 0;
}
#sidebar-footer {
  position:absolute;bottom:5px;
}
#footer {
  margin-bottom:20px;
}

/* center and adjust the sidebar contents on smaller devices */
@media (max-width: 768px) {
  #sidebar,#sidebar a.logo {
    text-align:center;
    margin:0 auto;
    margin-top:30px;
    font-size:26px;
  }
  #sidebar a.logo {
    font-size:50px;
    height:75px;
    width:75px;
    margin-bottom:30px;
  }
}



/* bootstrap overrides */

h1,h2,h3, .fap-segment {
   font-weight:800;
   font-family:'Open Sans',arial,sans-serif;
}

.jumbotron {
  background-color:transparent;
}
.label-default {
  background-color:#dddddd;
}
.page-header {
  margin-top: 55px;
  padding-top: 9px;
  border-top:1px solid #eeeeee;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:2px;
}

.col-sm-9.full {
    width: 100%;
}

small.text-muted {
  font-family:courier,courier-new,monospace;
}

h5.fap-segment {
    ine-height: 50px;
    font-size: 25px;
    color: white;

}
            .segment-con {

                width: 50px;
                height: 50px;
                font-size: 40px;
                border-radius: 25px;

                background: blue;
                text-align: center;
                margin-top: 15px;
            }


        </style>
    </head>
    
    <!-- HTML code from Bootply.com editor -->
    
    <body  >
        
        <div class="wrapper">
    <div class="box">
        <div class="row">
          
            <!-- sidebar -->
            <div class="column col-sm-3" id="sidebar">
                <h3>Fap Searches</h3>

                <p>What people try and find to get off to...</p>

                <form class="search">
                    <div class="input-group">
                        <input type="search" class="form-control" id="search_term" placeholder="enter single search term"/>
                        <span class="input-group-btn">
                            <input type="submit" id="report" class="btn btn-default smoothScroll" href="#search-results" value="Go!">
                        </span>
                    </div><!-- /input-group -->

                </form>


                <ul class="nav">
                    <li class="active"><a href="#searches">Summary</a>
                    </li>
                    <li><a href="#random">Random Searches</a>
                    </li>
                    <li><a href="#associated">Common Search Terms</a>
                    </li>
                    <li><a href="#orientation">Orientation Breakdown</a>
                    </li>
                </ul>
                <!--<h4 class="questions">Questions</h4>-->
                <!--<ul class="nav">-->
                    <!--<li class="active"><a href="#dataset">What am I searching through?</a>-->
                    <!--</li>-->
                    <!--<li><a href="/">Who built this?</a>-->
                    <!--</li>-->
                <!--</ul>-->
                <ul class="nav" id="sidebar-footer">
                    <li>
                          <p><a href="http://pornmd.com/getliveterms">Data</a> from the <i class="glyphicon glyphicon-heart-empty"></i> <a href="http://pornmd.com">PORNMD Network</a></p>
                    </li>
                </ul>
            </div>
            <!-- /sidebar -->
          
            <!-- main -->
            <div class="column col-sm-9" id="main">
                <div class="padding">
                    <div class="full col-sm-9">

                        <div class="col-sm-12" id="searches">
                            <div class="page-header text-muted divider">
                                Search Summary
                            </div>
                        </div>
                        <span id="search-summary">

                        </span>
                        
                        <div class="col-sm-12" id="random">
                          <div class="page-header text-muted divider">
                            Random Searches
                          </div>
                        </div>

                        <div class="row" id="search-results">

                        </div>

                        
                        <div class="col-sm-12" id="associated">
                          <div class="page-header text-muted divider">
                            Associated Terms
                          </div>
                        </div>
                        <!-- Terms #1 to 3 -->
                        <div class="row" id="frequent-global-terms">

                        </div>



                        <div class="col-sm-12" id="orientation">
                            <div class="page-header text-muted divider" >
                                Orientation Breakdown
                            </div>
                        </div>
                        <div class="col-sm-12">
                            <p>
                                This is NOT the sexuality of the person searching PORNMD. This IS the segment of PORNMD the person was searching from.
                            </p>
                        </div>
                        <!-- Terms #4 to 6 -->
                        <div class="row" id="frequent-segment-terms">

                        </div>


                        <div class="row divider">
                            <div class="col-sm-12"><hr></div>
                        </div>
                        <div class="row" id="footer">
                          <div class="col-sm-6">

                          </div>
                          <div class="col-sm-6">
                            <p>Created by <a href="http://smaxwellstewart.com">Simon Maxwell-Stewart</a>
                            using open source <a href="http://smaxwellstewart.com/open-sources">projects.</a>
                            </p>
                          </div>
                        </div>
                      

                        
                      
                    </div><!-- /col-9 -->
                </div><!-- /padding -->
            </div>
            <!-- /main -->
          
        </div>
    </div>
</div>
        
        <script type='text/javascript' src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script src="js/Chart.js"></script>
        <script src="js/numeral.js"></script>
        <script type='text/javascript'>
        
        $(document).ready(function() {

            var esURL = "http://107.170.79.184:9200";

            // Navigation shit
            $(".nav a").click(function(event){
                if ($(this).attr("href").indexOf("//")==-1) {
                    console.log($(this.hash).offset().top);
                    event.preventDefault();
                    $('body').animate({scrollTop:$('#sidebar').height()}, 1200, 'swing');
                    $('#main').animate({scrollTop:$(this.hash).position().top}, 1200, 'swing');

                }
            });

            // Make donut charts on page
            function makeDonut(term, percent, size) {


                var _donut = '<div class="col-sm-4 text-center">';
                _donut += '<h4>'+term+'</h4>';
                _donut += '<canvas id="per-'+term+'" height="'+size+'" width="'+size+'"></canvas>';
                _donut += '<br><p>'+percent+'%</p></div>';



                return _donut;
            }

//            var percentages = [10,20,30,40,50,60,66,67,56];
//            var donuts = [];
//            $.each(percentages, function(index, value) {
//                var donut = makeDonut(index, value)
//                donuts.push(donut);
//
//            });

            // Make ajax call

            function makePayload(search) {
                var payload = {
                    "size": 10,
                    "sort" : {
                        "_script" : {
                            "script" : "Math.random()",
                            "type" : "number",
                            "params" : {},
                            "order" : "asc"
                        }
                    }
                };

                if(search) {
                    var searchTemplate = {
                        "query" : { "query_string" : {"query" : "keyword:"+search} }
                    }

                    $.extend( payload, searchTemplate );
                }

                // Add aggregations
                var aggs = {
                    "aggs": {
                        "segment_report": {
                            "terms": {
                                "field": "segment"
                            }
                        },
                        "global_keywords": {
                            "terms": {
                                "field": "keyword",
                                "size": 6
                            }
                        }
                    }
                }

                $.extend( payload, aggs );

                return payload;


            }

            function getData(payload) {

                console.log('making post: ');
                console.log(JSON.stringify(payload));

                $.ajax({
                    type: "POST",
                    url: esURL+"/liveterms/porn/_search",
                    data: JSON.stringify(payload),
                    dataType: 'json'
                })
                .done(function( data ) {
                    console.log( data );
                    displayData(data)
                });
            }

            $('form.search').on('submit', function(e) {
                e.preventDefault();
                var search = $('#search_term').val();
                var post = makePayload(search);
                getData(post);
            });

            function displayData(data) {
                // Clear what was before
                $('#search-summary').html('');
                $('#search-results').html('');
                $('#frequent-global-terms').html('');
                $('#frequent-segment-terms').html('');

                // Set summary data
                var total = data.hits.total;
                var took = data.took;

                // Get Global count
                $.ajax({
                    type: "GET",
                    url: esURL+"/liveterms/porn/_count",
                    dataType: 'json'
                })
                .done(function( data ) {

                    var summary = makeSummary(took, total, data.count);
                    $('#search-summary').append(summary);
                });


                // Random Searches
                $.each(data.hits.hits, function(index, hit) {
                    var hit = makeHit(hit);
                    $('#search-results').append(hit);
                });

                // Associated Terms
                $.each(data.aggregations.global_keywords.buckets, function(index, bucket) {


                    var termStat = makeTermStat(bucket, total);


                    var donut = makeDonut(termStat.key, termStat.percent, 130);
                    var doughnutData = [
                        {
                            value: parseInt(termStat.percent),
                            color:"#1abc9c"
                        },
                        {
                            value : parseInt(100 - termStat.percent),
                            color : "#ecf0f1"
                        }
                    ];


                    $('#frequent-global-terms').append(donut);
                    var myDoughnut = new Chart(document.getElementById("per-"+termStat.key).getContext("2d")).Doughnut(doughnutData);
//                    var donut =
//                    console.log('Donut index: '+index+" Percent: "+termStat.percent);

                });

                // Orientation Summary
                $.each(data.aggregations.segment_report.buckets, function(index, bucket) {


                    var termStat = makeTermStat(bucket, total);

                    // Ammend bucket name to something more readable
                    switch( termStat.key) {
                        case 's':
                            termStat.key = 'Straight';
                            break;
                        case 'g':
                            termStat.key = 'Gay';
                            break;
                        default:
                            termStat.key = 'Trans';
                    }

                    var donut = makeDonut(termStat.key, termStat.percent, 130);
                    var doughnutData = [
                        {
                            value: parseInt(termStat.percent),
                            color:"#1abc9c"
                        },
                        {
                            value : parseInt(100 - termStat.percent),
                            color : "#ecf0f1"
                        }
                    ];


                    $('#frequent-segment-terms').append(donut);
                    var myDoughnut = new Chart(document.getElementById("per-"+termStat.key).getContext("2d")).Doughnut(doughnutData);
//                    var donut =
//                    console.log('Donut index: '+index+" Percent: "+termStat.percent);

                });

                // Scroll past sidebar for mobile users
                $('body').animate({scrollTop:$('#sidebar').height()}, 1200, 'swing');
                $('#main').animate({scrollTop:0}, 1200, 'swing');

            }

            function makeTermStat(term, total) {
                var percent = (term.doc_count/total)*100
                term.percent = numeral(percent).format('0');
                return term;
            }


            function makeHit(hit) {

                switch(hit._source.segment) {
                    case 's':
                        var color = 'red';
                        break;
                    case 'g':
                        var color = 'blue';
                        break;
                    case 't':
                        var color = 'purple';
                        break;
                    default:
                        var color = 'transparent';
                }
                var time = new Date(hit._source.time);
                var output = '<div class="row">';
                output +=     '<div class="col-xs-10">';
                output +=       '<h3>'+hit._source.keyword+'</h3>';
                output += '<small class="text-muted">'+time.toUTCString()+'</small>';
                output += '</h4>';
                output +=  '</div>';
                output += '<div class="col-xs-2">';
                output += '<div class="segment-con pull-right" style="background: '+color+';">';
                output += '<h5 class="fap-segment">'+hit._source.segment+'</h5>';
                output += '</div>';
                output += '</div>';
                output += '</div>';

                output += '<div class="row divider">';
                output += '<div class="col-sm-12"><hr></div>';
                output += '</div>';
                return output;
            }

            function makeSummary(took, total, globalTotal) {

                // Make percent
                var per = (total/globalTotal)*100;
                per = numeral(per).format('0.00');


                var output = '<div class="row">';
                output +=     '<div class="col-xs-10">';
                output +=       '<h3>'+total+' hits </h3>';
                output += '<small class="text-muted">took '+took+'<em>ms</em></small>';
                output += '</h4>';
                output +=  '</div>';
                output += '<div class="col-xs-2">';
                output += '<div class="pull-right">';
                output += '<h3>'+per+'%</h3>';
                output += '</div>';
                output += '</div>';
                output += '</div>';

                return output;

            }





            $('form.search').submit();

        });
        
        </script>
        
    </body>
</html>